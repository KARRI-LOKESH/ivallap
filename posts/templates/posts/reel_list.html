{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reels</title>
    <link rel="stylesheet" href="{% static 'posts/reel_list.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<div class="reel-container">
    {% for reel in reels %}
    <div class="reel" data-reel-id="{{ reel.id }}">
        <video src="{{ reel.video.url }}" loop playsinline controls></video>        

        <div class="reel-header">
            <a href="{% url 'user-profile' reel.user.username %}" class="reel-user">
                <div class="reel-profile-pic">
                    {% if reel.user.profile_pic %}
                        <img src="{{ reel.user.profile_pic.url }}" alt="Profile">
                    {% else %}
                        <img src="{% static 'users/images/default-profile.png' %}" alt="Default">
                    {% endif %}
                </div>
                <strong>{{ reel.user.username }}</strong>
            </a>

            {% if request.user != reel.user %}
            <form action="{% url 'follow-user' reel.user.id %}" method="POST" class="reel-follow-form">
                {% csrf_token %}
                {% if reel.user in request.user.following.all %}
                    <button type="submit" class="reel-btn-unfollow">Following</button>
                {% else %}
                    <button type="submit" class="reel-btn-follow">Follow</button>
                {% endif %}
            </form>
            {% endif %}
        </div>
        <p class="reel-caption">
                <span id="reel-content-{{ reel.id }}" class="reel-content" data-full-text="{{ reel.caption|escapejs }}">
                    {{ reel.caption|slice:":30" }}{% if reel.caption|length > 30 %}...{% endif %}
                </span>
                {% if reel.caption|length > 30 %}
                    <a href="javascript:void(0);" class="toggle-more" id="reel-toggle-{{ reel.id }}" onclick="toggleReelContent({{ reel.id }})">More</a>
                {% endif %}
            </p>
        <div class="reel-overlay">
            <div class="reel-actions">
                <div class="reel-action like-btn" data-reel-id="{{ reel.id }}" data-liked="{{ reel.is_liked }}">
                   {% if request.user in reel.likes.all %}
                        <i class="fa-solid fa-heart"></i>
                    {% else %}
                        <i class="fa-regular fa-heart"></i>
                    {% endif %}
                    <span>{{ reel.total_likes }}</span>
                </div>
                <div class="reel-action comment-btn" data-reel-id="{{ reel.id }}">
                <i class="fa-regular fa-comment"></i>
                <span>{{ reel.comments.count }}</span>
            </div>
                <div class="reel-action share-btn" data-reel-id="{{ reel.id }}">
                    <i class="fa-solid fa-paper-plane"></i>
                    <span>{{ reel.share.count }}</span>
                </div>
            </div>

            <div class="like-animation">❤️</div>
        </div>
    </div>
    {% endfor %}
</div>
<script>
    // Pause other videos when one starts playing
    document.addEventListener('DOMContentLoaded', function () {
        const videos = document.querySelectorAll('video');
        videos.forEach(video => {
            video.addEventListener('play', () => {
                videos.forEach(other => {
                    if (other !== video && !other.paused) {
                        other.pause();
                    }
                });
            });
        });
    });

    // CSRF Token function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Toggle More/Less for caption
    function toggleReelContent(id) {
        const contentSpan = document.getElementById(`reel-content-${id}`);
        const toggleLink = document.getElementById(`reel-toggle-${id}`);
        const fullText = contentSpan.getAttribute("data-full-text");

        if (toggleLink.innerText === "More") {
            contentSpan.innerText = fullText;
            toggleLink.innerText = "Less";
        } else {
            contentSpan.innerText = fullText.slice(0, 30) + "...";
            toggleLink.innerText = "More";
        }
    }

    // Like functionality
    $(document).on('click', '.like-btn', function () {
        const btn = $(this);
        const reelId = btn.data('reel-id');

        $.ajax({
            type: 'POST',
            url: `/posts/reels/${reelId}/like/`, // ✅ Update the path if your URL is prefixed
            headers: { 'X-CSRFToken': csrftoken },
            success: function (data) {
                btn.attr('data-liked', data.liked);
                btn.find('span').text(data.total_likes);

                const icon = btn.find('i');
                icon.removeClass(data.liked ? 'fa-regular fa-heart' : 'fa-solid fa-heart');
                icon.addClass(data.liked ? 'fa-solid fa-heart' : 'fa-regular fa-heart');
            },
            error: function () {
                console.error("Like failed");
            }
        });
    });

    // Save functionality
    $(document).on('click', '.save-btn', function () {
        const btn = $(this);
        const reelId = btn.data('reel-id');

        $.ajax({
            type: 'POST',
            url: `/posts/reels/${reelId}/save/`, // ✅ Make sure this route exists
            headers: { 'X-CSRFToken': csrftoken },
            success: function (data) {
                btn.attr('data-saved', data.saved);

                const icon = btn.find('i');
                icon.removeClass(data.saved ? 'fa-regular fa-bookmark' : 'fa-solid fa-bookmark');
                icon.addClass(data.saved ? 'fa-solid fa-bookmark' : 'fa-regular fa-bookmark');
            }
        });
    });

    // Comment redirection
    $(document).on('click', '.comment-btn', function () {
        const reelId = $(this).data('reel-id');
        window.location.href = `/posts/reels/${reelId}/comments/`; // ✅ Adjust if comments page is namespaced
    });

    // Share functionality
    $(document).on('click', '.share-btn', function () {
        const reelId = $(this).data('reel-id');
        const link = `${window.location.origin}/posts/reels/${reelId}/`; // ✅ Adjust base URL
        navigator.clipboard.writeText(link)
            .then(() => alert("Reel link copied to clipboard!"))
            .catch(() => alert("Failed to copy link."));
    });
</script>
</body>
</html>
