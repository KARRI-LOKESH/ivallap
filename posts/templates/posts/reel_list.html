{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reels</title>
    <link rel="stylesheet" href="{% static 'posts/reels.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>

<div class="reel-container">
    {% for reel in reels %}
    <div class="reel" data-reel-id="{{ reel.id }}">
        <video src="{{ reel.video.url }}" loop playsinline controls>
        </video>        
        <div class="reel-header">
            <a href="{% url 'user-profile' reel.user.username %}" class="reel-user">
                <div class="reel-profile-pic">
                    {% if reel.user.profile_pic %}
                        <img src="{{ reel.user.profile_pic.url }}" alt="Profile">
                    {% else %}
                        <img src="{% static 'users/images/default-profile.png' %}" alt="Default">
                    {% endif %}
                </div>
                <strong>{{ reel.user.username }}</strong>
            </a>
        
            {% if request.user != reel.user %}
            <form action="{% url 'follow-user' reel.user.id %}" method="POST" class="reel-follow-form">
                {% csrf_token %}
                {% if reel.user in request.user.following.all %}
                    <button type="submit" class="reel-btn-unfollow">Following</button>
                {% else %}
                    <button type="submit" class="reel-btn-follow">Follow</button>
                {% endif %}
            </form>
            {% endif %}
        </div>
        
        <div class="reel-overlay">
            <div class="reel-actions">
                <div class="reel-action like-btn" data-reel-id="{{ reel.id }}" data-liked="{{ reel.is_liked }}">
                   {% if request.user in reel.likes.all %}
                   {% csrf_token %}
                        <i class="fa-solid fa-heart"></i>
                    {% else %}
                        <i class="fa-regular fa-heart"></i>
                    {% endif %}
                    <span>{{ reel.total_likes }}</span>
                </div>
                <div class="reel-action comment-btn" data-reel-id="{{ reel.id }}" >
                    <i class="fa-regular fa-comment"></i>
                    <span>{{ reel.total_comments }}</span>
                </div>
                <div class="reel-action save-btn" data-reel-id="{{ reel.id }}" data-saved="{{ reel.is_saved }}">
                    {% if reel.is_saved %}
                        <i class="fa-solid fa-bookmark"></i>
                    {% else %}
                        <i class="fa-regular fa-bookmark"></i>
                    {% endif %}
                </div>
                
                <div class="reel-action share-btn" data-reel-id="{{ reel.id }}">
                    <i class="fa-solid fa-paper-plane"></i>
                </div>
                
        </div>

        <div class="like-animation">❤️</div>
    </div>
    {% endfor %}
</div>
<script>
    // Pause other videos on play
    document.addEventListener('DOMContentLoaded', function () {
        const videos = document.querySelectorAll('video');
        videos.forEach(video => {
            video.addEventListener('play', () => {
                videos.forEach(other => {
                    if (other !== video && !other.paused) {
                        other.pause();
                    }
                });
            });
        });
    });
</script>
<script>
    // CSRF token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Like button functionality
    function likeReel(reelId) {
        fetch(`/reels/${reelId}/like/`, {
            method: "POST",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
            },
            credentials: "same-origin",
        })
        .then(response => response.json())
        .then(data => {
            const likeBtn = document.querySelector(`.like-btn[data-reel-id="${reelId}"]`);
            if (likeBtn) {
                likeBtn.setAttribute("data-liked", data.liked);
                likeBtn.querySelector("span").textContent = data.total_likes;
    
                const icon = likeBtn.querySelector("i");
                if (icon) {
                    icon.className = data.liked ? "fa-solid fa-heart" : "fa-regular fa-heart";
                }
            }
        })
        .catch(error => console.error("Reel like error:", error));
    }
    
    // Save button functionality
    $('.save-btn').click(function () {
        const btn = $(this);
        const reelId = btn.data('reel-id');

        $.ajax({
            type: 'POST',
            url: `/reels/${reelId}/save/`,
            headers: { 'X-CSRFToken': csrftoken },
            success: function (data) {
                btn.attr('data-saved', data.saved);

                const icon = btn.find('i');
                icon.removeClass(data.saved ? 'fa-regular fa-bookmark' : 'fa-solid fa-bookmark');
                icon.addClass(data.saved ? 'fa-solid fa-bookmark' : 'fa-regular fa-bookmark');
            }
        });
    });
</script>

<script src="{% static 'posts/post_list.js' %}"></script>
</body>
</html>
