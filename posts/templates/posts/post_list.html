{% extends 'posts/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'posts/post_list.css' %}">

<h2>All Posts</h2>

{% for post in posts %}
    <div class="post" data-post-id="{{ post.id }}">
        <p><strong>{{ post.user.username }}</strong> - {{ post.created_at }}</p>
        <p>{{ post.content }}</p>
        
        {% if post.image %}
            <img src="{{ post.image.url }}" alt="Post Image" style="max-width: 100%; height: auto;">
        {% endif %}
        {% if post.video %}
        <video width="400" controls>
            <source src="{{ post.video.url }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    {% endif %}
        
        <br>

        <!-- View Post Button -->
        <a href="{% url 'post-detail' post.id %}" class="btn btn-primary">ğŸ‘ï¸View</a>

        <!-- Edit and Delete Buttons (Only for post owner) -->
        {% if request.user == post.user %}
            <a href="{% url 'post-update' post.id %}" class="btn btn-warning">âœï¸Edit</a>
            <a href="{% url 'post-delete' post.id %}" class="btn btn-danger">ğŸ—‘ï¸Delete</a>
        {% endif %}

        <!-- Like Button -->
        <form action="{% url 'like-post' post.id %}" method="POST" style="display: inline;">
            {% csrf_token %}
            <button class="like-btn" data-post-id="{{ post.id }}">
                {% if request.user in post.likes.all %}
                    ğŸ‘UnLike
                {% else %}
                    ğŸ‘Like
                {% endif %}
            </button>
            <span id="like-count-{{ post.id }}">{{ post.total_likes }}</span>
        </form>

        <!-- Save Button -->
        <form action="{% url 'save-post' post.id %}" method="POST" style="display: inline;">
            {% csrf_token %}
            <button type="submit">
                {% if request.user in post.saved_by.all %}
                    âŒUnSave
                {% else %}
                    ğŸ’¾Save
                {% endif %}
            </button>
            <span>{{ post.total_saves }}</span>
        </form>

        <!-- Comment Section -->
        <form action="{% url 'add-comment' post.id %}" method="POST">
            {% csrf_token %}
            <input type="text" name="content" placeholder="Add a comment" required>
            <button type="submit">ğŸ’¬Comment</button>
        </form>

        <p><strong>Comments ({{ post.comments.count }})</strong></p>

        {% if post.comments.exists %}
            <!-- Display last 2 comments -->
            <ul id="limited-comments-{{ post.id }}">
                {% for comment in post.comments.all|slice:"-2:" %}
                    <li><strong>{{ comment.user.username }}</strong>: {{ comment.content }}</li>
                {% endfor %}
            </ul>

            <!-- Hidden full comment list -->
            <ul id="full-comments-{{ post.id }}" style="display: none;">
                {% for comment in post.comments.all %}
                    <li><strong>{{ comment.user.username }}</strong>: {{ comment.content }}</li>
                {% endfor %}
            </ul>

            <!-- Toggle Button -->
            <button id="toggle-btn-{{ post.id }}">View all comments</button>
        {% else %}
            <p>No comments yet. Be the first to comment!</p>
        {% endif %}

        <!-- Share Button -->
        <button class="share-btn" data-post-url="{{ request.build_absolute_uri|slice:':-1' }}{% url 'post-detail' post.id %}">ğŸ”— Share</button>      

        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|slice:':-1' }}{% url 'post-detail' post.id %}" target="_blank">
            ğŸ“˜ Share on Facebook
        </a>

        <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri|slice:':-1' }}{% url 'post-detail' post.id %}&text=Check%20this%20post!" target="_blank">
            ğŸ¦ Share on Twitter
        </a>

        <a href="https://api.whatsapp.com/send?text={{ request.build_absolute_uri|slice:':-1' }}{% url 'post-detail' post.id %}" target="_blank">
            ğŸ“² Share on WhatsApp
        </a>

    </div>
    <hr>
{% endfor %}

<!-- Load JavaScript -->
<script src="{% static 'posts/post_list.js' %}"></script>

{% endblock %}
