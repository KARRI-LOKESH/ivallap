{% load static %}
<h2>Comments</h2>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link rel="stylesheet" href="{% static 'posts/reel_comments.css' %}">

<form method="post" class="comment-form">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Add Comment</button>
</form>

<hr>

<ul class="comment-list">
    {% for comment in comments %}
        <li class="comment-item">
            <div class="post-header">
                <a href="{% url 'user-profile' comment.user.username %}" class="user-infoo">
                    <div class="profile-pic-smalli">
                        {% if comment.user.profile_pic %}
                            <img src="{{ comment.user.profile_pic.url }}" alt="{{ comment.user.username }}">
                        {% else %}
                            <img src="{% static 'users/images/default-profile.png' %}" alt="Default Profile">
                        {% endif %}
                    </div>
                    <strong class="username-link">{{ comment.user.username }}</strong>
                </a>
            </div>
            <div class="comment-content">
                <div class="comment-header">
                    <span class="comment-actions">
                        <!-- Like button -->
                        {% if request.user in comment.likes.all %}
                            <i class="fa-solid fa-heart like-icon liked" data-comment-id="{{ comment.id }}"></i>
                            
                            <!-- Post owner's like indicator -->
                            {% if comment.post.user == request.user %}
                                <div class="owner-like-indicator">
                                    <img src="{{ comment.post.user.profile_pic.url }}" class="owner-like-avatar" alt="Owner Like">
                                    <i class="fa-solid fa-heart liked-owner"></i>
                                </div>
                            {% endif %}
                        {% else %}
                            <i class="fa-regular fa-heart like-icon" data-comment-id="{{ comment.id }}"></i>
                        {% endif %}

                        <span class="like-count" id="like-count-{{ comment.id }}">{{ comment.total_likes }}</span>

                        {% if comment.user == request.user %}
                            <a href="{% url 'delete_comment' comment.id %}" class="delete-icon">
                                <i class="fa-solid fa-trash"></i>
                            </a>
                        {% endif %}
                    </span>
                </div>
                <p>{{ comment.content }}</p>
            </div>
        </li>
    {% empty %}
        <li>No comments yet.</li>
    {% endfor %}
</ul>

<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.like-icon').forEach(icon => {
        icon.addEventListener('click', function () {
            const commentId = this.getAttribute('data-comment-id');

            fetch(`/posts/comment/${commentId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `comment_id=${commentId}`
            })
            .then(response => response.json())
            .then(data => {
                const countSpan = document.getElementById(`like-count-${commentId}`);
                countSpan.textContent = data.total_likes;

                if (data.liked) {
                    this.classList.remove('fa-regular');
                    this.classList.add('fa-solid', 'liked');
                } else {
                    this.classList.remove('fa-solid', 'liked');
                    this.classList.add('fa-regular');
                }
            });
        });
    });
});
</script>
